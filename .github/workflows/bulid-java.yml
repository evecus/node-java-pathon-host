name: Java Build and Auto-Push

on:
  push:
    branches: [ "main" ] # 当你向 main 分支推送代码时触发
  workflow_dispatch:      # 允许你在 GitHub 页面手动点击运行

permissions:
  contents: write        # 赋予 Action 向你的仓库写入文件的权限

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Compile and Create JAR
        run: |
          # 进入 java/src 目录
          cd java/src
          
          # 1. 编译代码
          javac minecraft.java
          
          # 2. 生成 Manifest 文件 (注意 Main-Class 后面有空格，且有换行)
          printf "Main-Class: minecraft\n\n" > Manifest.txt
          
          # 3. 打包成 server.jar
          jar cvmf Manifest.txt server.jar minecraft.class
          
          # 4. 清理编译产生的临时文件
          rm Manifest.txt
          rm minecraft.class

      - name: Commit and Push JAR
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 强制添加 server.jar，即使它在 .gitignore 中 (如果有的话)
          git add java/src/server.jar
          
          # 检查是否有文件更改，避免没有变化时提交报错
          if git diff --staged --quiet; then
            echo "No changes in server.jar, skipping commit."
          else
            git commit -m "chore: auto-update server.jar [skip ci]"
            git push
          fi
